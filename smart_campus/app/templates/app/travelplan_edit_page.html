{% extends 'app/base.html' %}
{% load static %}

{% block title %}Smart Campus{% endblock %}

{% block stylesheet %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/trix/0.11.0/trix.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/trix/0.11.0/trix.js"></script>
  <link rel="stylesheet" type="text/css" href="{% static "app/css/edit.css" %}">
  <link rel="stylesheet" type="text/css" href="{% static "app/css/travelplan_edit_page.css" %}">
{% endblock %}
{% block content %}
<div class="ui container">

  <div class="ui centered big form" enctype="multipart/form-data" id="travelplan_form">
    {% for field in form %}
      {% if field.errors %}
        <div class="ui negative message">
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error|escape }}</li>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}
    <div class="field">
      <label>行程名稱</label>
      <input id="name" name="name" type="text" placeholder="行程名稱" value="{{ form_data.name }}" required="">
    </div>
    <hr>
    <div class="field">
      <label>行程描述</label>
      <textarea name="description" rows="4">{{form_data.description}}</textarea>
    </div>
    <hr>
    <!-- Button : Change Image -->
    <div class="field">
      <label>更新圖片</label>
      {% if travelplan.image %}
        <div class="ui centered card">
          <div class="ui medium image">
            <div class="ui dimmer">
              <div class="content">
                <div class="center">
                    <a class="ui small red button" href="">刪除</a>
                </div>
              </div>
            </div>
            <img src="{{ travelplan.image.url }}">
          </div>
        </div>
      {% endif %}
      <div class="ui center aligned grid">
        <div class="five wide field">
          <div id="uiAddImage">
            <div class="ui action input">
              <input type="text" placeholder="img 1" readonly="">
              <input id="image" name="image" type="file" accept="image/*" style="display: none;">
              <div class="ui icon button">
                <i class="attach icon"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr>
    <div class="field">
      <label>行程站點規劃</label>
      <div class="ui center aligned text container">
        <div class="column">
          <i class="angle down icon"></i>
        </div>
      </div>
      <div class="ui center aligned grid">
        <div class="column">
          <div class="ui vertical steps" id="sortable">
            {% if selected_stations %}
              {% for station in selected_stations %}
                <div class="completed step" id="travelplan" data-id='{{ station.id }}'>
                  <div class="content" id="category">
                    <div class="title">{{ station.name }}</div>
                    <div class="description">
                      {{ station.category}}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="ui center aligned grid">
        <div class="column">
          <i class="angle double down icon"></i>
        </div>
      </div>
      <div class="ui center aligned grid">
        <div class="column">
        <div class="ui inline floating dropdown labeled search icon button">
          <i class="search icon"></i>
          <span class="text" id="selectedStationId">選擇站點</span>
          <div class="menu" id="selectionMenu">
            {% if stations %}
              {% for station in stations %}
                <div class="item" data-value="{{ station.id }}" category="{{ station.category }}">
                  {{ station.name }}
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
        <div class="right attached ui labeled icon button" id="addStationButton">
          <i class="plus icon"></i>
          來新增
        </div>
      </div>
    </div>
    <hr>
    <div class="ui fluid teal submit button" id="submitButton">儲存站點資訊</div>
  </div>
</div>

{% endblock %}

{% block script %}
  {{ block.super }}
  <script src="//cdn.jsdelivr.net/npm/sortablejs@1.6.1/Sortable.min.js"></script>
  <script type="text/javascript">
    window.CSRF_TOKEN = "{{ csrf_token }}"
    $(document).ready(function() {
      let selectedId, selectedStationName, selectedCategory
      $('.ui.inline.floating.dropdown.labeled.search.icon.button').dropdown({
        onChange: function(value, text, $selectedItem) {
                    selectedId = value
                    selectedStationName = text
                    selectedCategory = $selectedItem.attr('category')
                  }
      })

      let el = document.getElementById('sortable')
      let order = {}
      Sortable.create(el, {
        store: {
          /**
            * Get the order of elements. Called once during initialization.
            * @param   {Sortable}  sortable
            * @returns {Array}
            */
          get: function (sortable) {
            return order = sortable.toArray()
          },
          /**
            * Save the order of elements. Called onEnd (when the item is dropped).
            * @param {Sortable}  sortable
            */
          set: function (sortable) {
            order = sortable.toArray()
          }
        }
      })

      $('#submitButton').on('click', function() {
        let postData = new FormData()
        postData.append('name', $('#name').val())
        postData.append('description', $('textarea').val())
        if($('input[type=file]')[0].files[0]) {
          postData.append('image', $('input[type=file]')[0].files[0])
        }
        postData.append('order', JSON.stringify(order))
        postData.append('csrfmiddlewaretoken', window.CSRF_TOKEN)
        $.ajax({
          url: window.location.pathname,
          type: 'POST',
          data: postData,
          cache: false,
          contentType: false,
          processData: false
        })
      })

      $('[id=travelplan]').each( function() {
        $(this).on( "mouseover", function() {
          $(this).removeClass("completed step")
          $(this).addClass("active step")
        })
      })
      $('[id=travelplan]').each( function() {
        $(this).on( "mouseout", function() {
          $(this).removeClass("active step")
          $(this).addClass("completed step")
        })
      })
      $('#addStationButton').on('click', function() {
        if(/^[\d\.]$/.test(selectedId)) {
          $('#sortable').append(
              '<div class="completed step" id="travelplan" data-id="' + selectedId +
              '"><div class="content" id="category"><div class="title">' +
                selectedStationName + '</div><div class="description">' +
                selectedCategory + '</div></div></div>'
            )
          let selector = "div[data-id=" + selectedId + "]"
          $('.item.active.selected').remove()
          $('#selectedStationId').empty()
          $(document).on('mouseover', selector, function() {
            $(this).removeClass("completed step")
            $(this).addClass("active step")
          })
          $(document).on('mouseout', selector, function() {
            $(this).removeClass("active step")
            $(this).addClass("completed step")
          })
          order.push(selectedId)
        }
      })

    })
  </script>
{% endblock %}
